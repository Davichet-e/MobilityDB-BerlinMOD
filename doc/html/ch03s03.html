<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>BerlinMOD/R Queries</title><link rel="stylesheet" type="text/css" href="docbook.css"><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"><link rel="home" href="index.html" title="BerlinMOD Benchmark on MobilityDB"><link rel="up" href="ch03.html" title="Chapter 3. BerlinMOD Benchmark on MobilityDB"><link rel="prev" href="ch03s02.html" title="Loading the Data in Partitioned Tables"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">BerlinMOD/R Queries</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch03s02.html">Prev</a> </td><th width="60%" align="center">Chapter 3. BerlinMOD Benchmark on MobilityDB</th><td width="20%" align="right"> </td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm985"></a>BerlinMOD/R Queries</h2></div></div></div><p>The script for querying BerlinMOD data loaded in MobilityDB with the BerlinMOD/R queries is available <a class="ulink" href="https://docs.mobilitydb.com/data/berlinmod_queries.sql" target="_top">here</a>.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>What are the models of the vehicles with licence plate numbers from <code class="varname">Licences</code>?</p><pre class="programlisting">
SELECT DISTINCT L.Licence, C.Model AS Model
FROM Vehicles C, Licences L
WHERE C.Licence = L.Licence;
</pre></li><li class="listitem"><p>How many vehicles exist that are passenger cars?</p><pre class="programlisting">
SELECT COUNT (Licence)
FROM Vehicles C
WHERE Type = 'passenger';
</pre></li><li class="listitem"><p>Where have the vehicles with licences from <code class="varname">Licences1</code> been at each of the instants from <code class="varname">Instants1</code>?</p><pre class="programlisting">
SELECT DISTINCT L.Licence, I.InstantId, I.Instant AS Instant,
  valueAtTimestamp(T.Trip, I.Instant) AS Pos
FROM Trips T, Licences1 L, Instants1 I
WHERE T.VehId = L.VehId AND valueAtTimestamp(T.Trip, I.Instant) IS NOT NULL
ORDER BY L.Licence, I.InstantId;
</pre></li><li class="listitem"><p>Which vehicles have passed the points from <code class="varname">Points</code>?</p><pre class="programlisting">
SELECT DISTINCT P.PointId, P.Geom, C.Licence
FROM Trips T, Vehicles C, Points P
WHERE T.VehId = C.VehId AND T.Trip &amp;&amp; P.Geom AND
  ST_Intersects(trajectory(T.Trip), P.Geom) 
ORDER BY P.PointId, C.Licence;
</pre></li><li class="listitem"><p>What is the minimum distance between places, where a vehicle with a licence from <code class="varname">Licences1</code> and a vehicle with a licence from <code class="varname">Licences2</code> have been?</p><pre class="programlisting">
SELECT L1.Licence AS Licence1, L2.Licence AS Licence2,
  MIN(ST_Distance(trajectory(T1.Trip), trajectory(T2.Trip))) AS MinDist
FROM Trips T1, Licences1 L1, Trips T2, Licences2 L2
WHERE T1.VehId = L1.VehId AND T2.VehId = L2.VehId AND T1.VehId &lt; T2.VehId
GROUP BY L1.Licence, L2.Licence 
ORDER BY L1.Licence, L2.Licence;
</pre></li><li class="listitem"><p>What are the pairs of trucks that have ever been as close as 10m or less to each other?</p><pre class="programlisting">
SELECT DISTINCT C1.Licence AS Licence1, C2.Licence AS Licence2
FROM Trips T1, Vehicles C1, Trips T2, Vehicles C2
WHERE T1.VehId = C1.VehId AND T2.VehId = C2.VehId AND
  T1.VehId &lt; T2.VehId AND C1.Type = 'truck' AND C2.Type = 'truck' AND
  T1.Trip &amp;&amp; expandSpatial(T2.Trip, 10) AND
  tdwithin(T1.Trip, T2.Trip, 10.0) ?= true
ORDER BY C1.Licence, C2.Licence;
</pre></li><li class="listitem"><p>What are the licence plate numbers of the passenger cars that have reached the points from <code class="varname">Points</code> first of all passenger cars during the complete observation period?</p><pre class="programlisting">
WITH Timestamps AS (
  SELECT DISTINCT C.Licence, P.PointId, P.Geom, 
    MIN(startTimestamp(atValue(T.Trip,P.Geom))) AS Instant
  FROM Trips T, Vehicles C, Points1 P
  WHERE T.VehId = C.VehId AND C.Type = 'passenger' AND
    T.Trip &amp;&amp; P.Geom AND ST_Intersects(trajectory(T.Trip), P.Geom)
  GROUP BY C.Licence, P.PointId, P.Geom )
SELECT T1.Licence, T1.PointId, T1.Geom, T1.Instant
FROM Timestamps T1
WHERE T1.Instant &lt;= ALL (
  SELECT T2.Instant
  FROM Timestamps T2
  WHERE T1.PointId = T2.PointId )
ORDER BY T1.PointId, T1.Licence;
</pre></li><li class="listitem"><p>What are the overall travelled distances of the vehicles with licence plate numbers from <code class="varname">Licences1</code> during the periods from <code class="varname">Periods1</code>?</p><pre class="programlisting">
SELECT L.Licence, P.PeriodId, P.Period, SUM(length(atPeriod(T.Trip, P.Period))) AS Dist
FROM Trips T, Licences1 L, Periods1 P
WHERE T.VehId = L.VehId AND T.Trip &amp;&amp; P.Period
GROUP BY L.Licence, P.PeriodId, P.Period 
ORDER BY L.Licence, P.PeriodId;
</pre></li><li class="listitem"><p>What is the longest distance that was travelled by a vehicle during each of the periods from <code class="varname">Periods</code>?</p><pre class="programlisting">
WITH Distances AS (
  SELECT P.PeriodId, P.Period, T.VehId, SUM(length(atPeriod(T.Trip, P.Period))) AS Dist
  FROM Trips T, Periods P
  WHERE T.Trip &amp;&amp; P.Period
  GROUP BY P.PeriodId, P.Period, T.VehId )
SELECT PeriodId, Period, MAX(Dist) AS MaxDist
FROM Distances
GROUP BY PeriodId, Period
ORDER BY PeriodId;
</pre></li><li class="listitem"><p>When and where did the vehicles with licence plate numbers from <code class="varname">Licences1</code> meet other vehicles (distance &lt; 3m) and what are the latter licences?</p><pre class="programlisting">
WITH Values AS (
  SELECT DISTINCT L1.Licence AS QueryLicence, C2.Licence AS OtherLicence,
    atPeriodSet(T1.Trip, getTime(atValue(tdwithin(T1.Trip, T2.Trip, 3.0), TRUE))) AS Pos
  FROM Trips T1, Licences1 L1, Trips T2, Licences2 C2 
  WHERE T1.VehId = L1.VehId AND T2.VehId = C2.VehId AND T1.VehId &lt; T2.VehId AND
    expandSpatial(T1.Trip, 3) &amp;&amp; expandSpatial(T2.Trip, 3) 
    dwithin(T1.Trip, T2.Trip, 3.0) )
SELECT QueryLicence, OtherLicence, array_agg(Pos ORDER BY startTimestamp(Pos)) AS Pos
FROM Values 
GROUP BY QueryLicence, OtherLicence
ORDER BY QueryLicence, OtherLicence;
</pre></li><li class="listitem"><p>Which vehicles passed a point from <code class="varname">Points1</code> at one of the instants from <code class="varname">Instants1</code>?</p><pre class="programlisting">
SELECT P.PointId, P.Geom, I.InstantId, I.Instant, C.Licence
FROM Trips T, Vehicles C, Points1 P, Instants1 I
WHERE T.VehId = C.VehId AND T.Trip @&gt; STBOX(P.Geom, I.Instant) AND
  valueAtTimestamp(T.Trip, I.Instant) = P.Geom
ORDER BY P.PointId, I.InstantId, C.Licence;
</pre></li><li class="listitem"><p>Which vehicles met at a point from <code class="varname">Points1</code> at an instant from <code class="varname">Instants1</code>?</p><pre class="programlisting">
SELECT DISTINCT P.PointId, P.Geom, I.InstantId, I.Instant,
  C1.Licence AS Licence1, C2.Licence AS Licence2
FROM Trips T1, Vehicles C1, Trips T2, Vehicles C2, Points1 P, Instants1 I
WHERE T1.VehId = C1.VehId AND T2.VehId = C2.VehId AND T1.VehId &lt; T2.VehId AND
  T1.Trip @&gt; STBOX(P.Geom, I.Instant) AND T2.Trip @&gt; STBOX(P.Geom, I.Instant) AND
  valueAtTimestamp(T1.Trip, I.Instant) = P.Geom AND
  valueAtTimestamp(T2.Trip, I.Instant) = P.Geom
ORDER BY P.PointId, I.InstantId, C1.Licence, C2.Licence;
</pre></li><li class="listitem"><p>Which vehicles travelled within one of the regions from <code class="varname">Regions1</code> during the periods from <code class="varname">Periods1</code>?</p><pre class="programlisting">
SELECT DISTINCT R.RegionId, P.PeriodId, P.Period, C.Licence
FROM Trips T, Vehicles C, Regions1 R, Periods1 P
WHERE T.VehId = C.VehId AND T.trip &amp;&amp; STBOX(R.Geom, P.Period) AND
  ST_Intersects(trajectory(atPeriod(T.Trip, P.Period)), R.Geom)
ORDER BY R.RegionId, P.PeriodId, C.Licence;
</pre></li><li class="listitem"><p>Which vehicles travelled within one of the regions from <code class="varname">Regions1</code> at one of the instants from <code class="varname">Instants1</code>?</p><pre class="programlisting">
SELECT DISTINCT R.RegionId, I.InstantId, I.Instant, C.Licence
FROM Trips T, Vehicles C, Regions1 R, Instants1 I
WHERE T.VehId = C.VehId AND T.Trip &amp;&amp; STBOX(R.Geom, I.Instant) AND
  ST_Contains(R.Geom, valueAtTimestamp(T.Trip, I.Instant))
ORDER BY R.RegionId, I.InstantId, C.Licence;
</pre></li><li class="listitem"><p>Which vehicles passed a point from <code class="varname">Points1</code> during a period from <code class="varname">Periods1</code>?</p><pre class="programlisting">
SELECT DISTINCT PO.PointId, PO.Geom, PR.PeriodId, PR.Period, C.Licence
FROM Trips T, Vehicles C, Points1 PO, Periods1 PR
WHERE T.VehId = C.VehId AND T.Trip &amp;&amp; STBOX(PO.Geom, PR.Period) AND
  ST_Intersects(trajectory(atPeriod(T.Trip, PR.Period)),PO.Geom)
ORDER BY PO.PointId, PR.PeriodId, C.Licence;
</pre></li><li class="listitem"><p>List the pairs of licences for vehicles, the first from <code class="varname">Licences1</code>, the second from <code class="varname">Licences2</code>, where the corresponding vehicles are both present within a region from <code class="varname">Regions1</code> during a period from <code class="varname">QueryPeriod1</code>, but do not meet each other there and then.</p><pre class="programlisting">
SELECT P.PeriodId, P.Period, R.RegionId, L1.Licence AS Licence1, L2.Licence AS Licence2
FROM Trips T1, Licences1 L1, Trips T2, Licences2 L2, Periods1 P, Regions1 R
WHERE T1.VehId = L1.VehId AND T2.VehId = L2.VehId AND L1.Licence &lt; L2.Licence AND
  T1.Trip &amp;&amp; STBOX(R.Geom, P.Period) AND T2.Trip &amp;&amp; STBOX(R.Geom, P.Period) AND
  ST_Intersects(trajectory(atPeriod(T1.Trip, P.Period)), R.Geom) AND
  ST_Intersects(trajectory(atPeriod(T2.Trip, P.Period)), R.Geom) AND
  tintersects(atPeriod(T1.Trip, P.Period), atPeriod(T2.Trip, P.Period)) %= FALSE
ORDER BY PeriodId, RegionId, Licence1, Licence2;
</pre></li><li class="listitem"><p>Which point(s) from <code class="varname">Points</code> have been visited by a maximum number of different vehicles?</p><pre class="programlisting">
WITH PointCount AS (
  SELECT P.PointId, COUNT(DISTINCT T.VehId) AS Hits
  FROM Trips T, Points P
  WHERE ST_Intersects(trajectory(T.Trip), P.Geom)
  GROUP BY P.PointId )
SELECT PointId, Hits
FROM PointCount AS P
WHERE P.Hits = ( SELECT MAX(Hits) FROM PointCount );
</pre></li></ol></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch03s02.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch03.html">Up</a></td><td width="40%" align="right"> </td></tr><tr><td width="40%" align="left" valign="top">Loading the Data in Partitioned Tables </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div></body></html>
