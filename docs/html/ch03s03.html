<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>BerlinMOD/r Queries</title><link rel="stylesheet" type="text/css" href="docbook.css"><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"><link rel="home" href="index.html" title="BerlinMOD Benchmark on MobilityDB"><link rel="up" href="ch03.html" title="Chapter 3. BerlinMOD Benchmark on MobilityDB"><link rel="prev" href="ch03s02.html" title="Loading the Data in Partitioned Tables"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">BerlinMOD/r Queries</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch03s02.html">Prev</a> </td><th width="60%" align="center">Chapter 3. BerlinMOD Benchmark on MobilityDB</th><td width="20%" align="right"> </td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm986"></a>BerlinMOD/r Queries</h2></div></div></div><p>The script for querying BerlinMOD data loaded in MobilityDB with the BerlinMOD/r queries is available <a class="ulink" href="https://docs.mobilitydb.com/data/berlinmod_queries.sql" target="_top">here</a>.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>What are the models of the vehicles with licence plate numbers from <code class="varname">Licences</code>?</p><pre class="programlisting">
SELECT DISTINCT l.Licence, v.Model AS Model
FROM Vehicles v, Licences l
WHERE v.Licence = l.Licence;
</pre></li><li class="listitem"><p>How many vehicles exist that are passenger cars?</p><pre class="programlisting">
SELECT COUNT (DISTINCT Licence)
FROM Vehicles v
WHERE VehicleType = 'passenger';
</pre></li><li class="listitem"><p>Where have the vehicles with licences from <code class="varname">Licences1</code> been at each of the instants from <code class="varname">Instants1</code>?</p><pre class="programlisting">
SELECT DISTINCT l.Licence, i.InstantId, i.Instant AS Instant,
  valueAtTimestamp(t.Trip, i.Instant) AS Pos
FROM Trips t, Licences1 l, Instants1 i
WHERE t.VehicleId = l.VehicleId AND valueAtTimestamp(t.Trip, i.Instant) IS NOT NULL
ORDER BY l.Licence, i.InstantId;
</pre></li><li class="listitem"><p>Which vehicles have passed the points from <code class="varname">Points</code>?</p><pre class="programlisting">
SELECT DISTINCT p.PointId, p.Geom, v.Licence
FROM Trips t, Vehicles v, Points p
WHERE t.VehicleId = v.VehicleId AND t.Trip &amp;&amp; stbox(p.Geom) AND
  ST_Intersects(trajectory(t.Trip), p.Geom) 
ORDER BY p.PointId, v.Licence;
</pre></li><li class="listitem"><p>What is the minimum distance between places, where a vehicle with a licence from <code class="varname">Licences1</code> and a vehicle with a licence from <code class="varname">Licences2</code> have been?</p><pre class="programlisting">
SELECT l1.Licence AS Licence1, l2.Licence AS Licence2,
  MIN(ST_Distance(trajectory(t1.Trip), trajectory(t2.Trip))) AS MinDist
FROM Trips t1, Licences1 l1, Trips t2, Licences2 l2
WHERE t1.VehicleId = l1.VehicleId AND t2.VehicleId = l2.VehicleId AND
  t1.VehicleId &lt; t2.VehicleId
GROUP BY l1.Licence, l2.Licence 
ORDER BY l1.Licence, l2.Licence;
</pre></li><li class="listitem"><p>What are the pairs of trucks that have ever been as close as 10m or less to each other?</p><pre class="programlisting">
SELECT DISTINCT v1.Licence AS Licence1, v2.Licence AS Licence2
FROM Trips t1, Vehicles v1, Trips t2, Vehicles v2
WHERE t1.VehicleId = v1.VehicleId AND t2.VehicleId = v2.VehicleId AND
  t1.VehicleId &lt; t2.VehicleId AND v1.VehicleType = 'truck' AND 
  v2.VehicleType = 'truck' AND t1.Trip &amp;&amp; expandSpace(t2.Trip, 10) AND
  eDwithin(t1.Trip, t2.Trip, 10.0)
ORDER BY v1.Licence, v2.Licence;
</pre></li><li class="listitem"><p>What are the licence plate numbers of the passenger cars that have reached the points from <code class="varname">Points</code> first of all passenger cars during the complete observation period?</p><pre class="programlisting">
WITH Timestamps AS (
  SELECT DISTINCT v.Licence, p.PointId, p.Geom, 
    MIN(startTimestamp(atValues(t.Trip,p.Geom))) AS Instant
  FROM Trips t, Vehicles v, Points1 p
  WHERE t.VehicleId = v.VehicleId AND v.VehicleType = 'passenger' AND
    t.Trip &amp;&amp; stbox(p.Geom) AND ST_Intersects(trajectory(t.Trip), p.Geom)
  GROUP BY v.Licence, p.PointId, p.Geom )
SELECT t1.Licence, t1.PointId, t1.Geom, t1.Instant
FROM Timestamps t1
WHERE t1.Instant &lt;= ALL (
  SELECT t2.Instant
  FROM Timestamps t2
  WHERE t1.PointId = t2.PointId )
ORDER BY t1.PointId, t1.Licence;
</pre></li><li class="listitem"><p>What are the overall travelled distances of the vehicles with licence plate numbers from <code class="varname">Licences1</code> during the periods from <code class="varname">Periods1</code>?</p><pre class="programlisting">
SELECT l.Licence, p.PeriodId, p.Period, SUM(length(atTime(t.Trip, p.Period))) AS Dist
FROM Trips t, Licences1 l, Periods1 p
WHERE t.VehicleId = l.VehicleId AND t.Trip &amp;&amp; p.Period
GROUP BY l.Licence, p.PeriodId, p.Period 
ORDER BY l.Licence, p.PeriodId;
</pre></li><li class="listitem"><p>What is the longest distance that was travelled by a vehicle during each of the periods from <code class="varname">Periods</code>?</p><pre class="programlisting">
WITH Distances AS (
  SELECT p.PeriodId, p.Period, t.VehicleId,
    SUM(length(atTime(t.Trip, p.Period))) AS Dist
  FROM Trips t, Periods p
  WHERE t.Trip &amp;&amp; p.Period
  GROUP BY p.PeriodId, p.Period, t.VehicleId )
SELECT PeriodId, Period, MAX(Dist) AS MaxDist
FROM Distances
GROUP BY PeriodId, Period
ORDER BY PeriodId;
</pre></li><li class="listitem"><p>When and where did the vehicles with licence plate numbers from <code class="varname">Licences1</code> meet other vehicles (distance &lt; 3m) and what are the latter licences?</p><pre class="programlisting">
WITH Values AS (
  SELECT DISTINCT l1.Licence AS QueryLicence, l2.Licence AS OtherLicence,
    atTime(t1.Trip, getTime(atValues(tdwithin(t1.Trip, t2.Trip, 3.0), TRUE))) AS Pos
  FROM Trips t1, Licences1 l1, Trips t2, Licences2 l2 
  WHERE t1.VehicleId = l1.VehicleId AND t2.VehicleId = l2.VehicleId AND
    t1.VehicleId &lt; t2.VehicleId AND 
    expandSpace(t1.Trip, 3) &amp;&amp; expandSpace(t2.Trip, 3) AND
    eDwithin(t1.Trip, t2.Trip, 3.0) )
SELECT QueryLicence, OtherLicence, array_agg(Pos ORDER BY startTimestamp(Pos)) AS Pos
FROM Values 
GROUP BY QueryLicence, OtherLicence
ORDER BY QueryLicence, OtherLicence;
</pre></li><li class="listitem"><p>Which vehicles passed a point from <code class="varname">Points1</code> at one of the instants from <code class="varname">Instants1</code>?</p><pre class="programlisting">
SELECT p.PointId, p.Geom, i.InstantId, i.Instant, v.Licence
FROM Trips t, Vehicles v, Points1 p, Instants1 i
WHERE t.VehicleId = v.VehicleId AND t.Trip @&gt; stbox(p.Geom, i.Instant) AND
  valueAtTimestamp(t.Trip, i.Instant) = p.Geom
ORDER BY p.PointId, i.InstantId, v.Licence;
</pre></li><li class="listitem"><p>Which vehicles met at a point from <code class="varname">Points1</code> at an instant from <code class="varname">Instants1</code>?</p><pre class="programlisting">
SELECT DISTINCT p.PointId, p.Geom, i.InstantId, i.Instant,
  v1.Licence AS Licence1, v2.Licence AS Licence2
FROM Trips t1, Vehicles v1, Trips t2, Vehicles v2, Points1 p, Instants1 i
WHERE t1.VehicleId = v1.VehicleId AND t2.VehicleId = v2.VehicleId AND
  t1.VehicleId &lt; t2.VehicleId AND t1.Trip @&gt; stbox(p.Geom, i.Instant) AND
  t2.Trip @&gt; stbox(p.Geom, i.Instant) AND
  valueAtTimestamp(t1.Trip, i.Instant) = p.Geom AND
  valueAtTimestamp(t2.Trip, i.Instant) = p.Geom
ORDER BY p.PointId, i.InstantId, v1.Licence, v2.Licence;
</pre></li><li class="listitem"><p>Which vehicles travelled within one of the regions from <code class="varname">Regions1</code> during the periods from <code class="varname">Periods1</code>?</p><pre class="programlisting">
SELECT DISTINCT r.RegionId, p.PeriodId, p.Period, v.Licence
FROM Trips t, Vehicles v, Regions1 r, Periods1 p
WHERE t.VehicleId = v.VehicleId AND t.trip &amp;&amp; stbox(r.Geom, p.Period) AND
  ST_Intersects(trajectory(atTime(t.Trip, p.Period)), r.Geom)
ORDER BY r.RegionId, p.PeriodId, v.Licence;
</pre></li><li class="listitem"><p>Which vehicles travelled within one of the regions from <code class="varname">Regions1</code> at one of the instants from <code class="varname">Instants1</code>?</p><pre class="programlisting">
SELECT DISTINCT r.RegionId, i.InstantId, i.Instant, v.Licence
FROM Trips t, Vehicles v, Regions1 r, Instants1 i
WHERE t.VehicleId = v.VehicleId AND t.Trip &amp;&amp; stbox(r.Geom, i.Instant) AND
  ST_Contains(r.Geom, valueAtTimestamp(t.Trip, i.Instant))
ORDER BY r.RegionId, i.InstantId, v.Licence;
</pre></li><li class="listitem"><p>Which vehicles passed a point from <code class="varname">Points1</code> during a period from <code class="varname">Periods1</code>?</p><pre class="programlisting">
SELECT DISTINCT pt.PointId, pt.Geom, pr.PeriodId, pr.Period, v.Licence
FROM Trips t, Vehicles v, Points1 pt, Periods1 pr
WHERE t.VehicleId = v.VehicleId AND t.Trip &amp;&amp; stbox(pt.Geom, pr.Period) AND
  ST_Intersects(trajectory(atTime(t.Trip, pr.Period)), pt.Geom)
ORDER BY pt.PointId, pr.PeriodId, v.Licence;
</pre></li><li class="listitem"><p>List the pairs of licences for vehicles, the first from <code class="varname">Licences1</code>, the second from <code class="varname">Licences2</code>, where the corresponding vehicles are both present within a region from <code class="varname">Regions1</code> during a period from <code class="varname">QueryPeriod1</code>, but do not meet each other there and then.</p><pre class="programlisting">
SELECT p.PeriodId, p.Period, r.RegionId, l1.Licence AS Licence1, l2.Licence AS Licence2
FROM Trips t1, Licences1 l1, Trips t2, Licences2 l2, Periods1 p, Regions1 r
WHERE t1.VehicleId = l1.VehicleId AND t2.VehicleId = l2.VehicleId AND
  l1.Licence &lt; l2.Licence AND t1.Trip &amp;&amp; stbox(r.Geom, p.Period) AND 
  t2.Trip &amp;&amp; stbox(r.Geom, p.Period) AND
  ST_Intersects(trajectory(atTime(t1.Trip, p.Period)), r.Geom) AND
  ST_Intersects(trajectory(atTime(t2.Trip, p.Period)), r.Geom) AND
  aDisjoint(atTime(t1.Trip, p.Period), atTime(t2.Trip, p.Period))
ORDER BY PeriodId, RegionId, Licence1, Licence2;
</pre></li><li class="listitem"><p>Which point(s) from <code class="varname">Points</code> have been visited by a maximum number of different vehicles?</p><pre class="programlisting">
WITH PointCount AS (
  SELECT p.PointId, COUNT(DISTINCT t.VehicleId) AS Hits
  FROM Trips t, Points p
  WHERE ST_Intersects(trajectory(t.Trip), p.Geom)
  GROUP BY p.PointId )
SELECT PointId, Hits
FROM PointCount AS p
WHERE p.Hits = ( SELECT MAX(Hits) FROM PointCount );
</pre></li></ol></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch03s02.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch03.html">Up</a></td><td width="40%" align="right"> </td></tr><tr><td width="40%" align="left" valign="top">Loading the Data in Partitioned Tables </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div></body></html>
